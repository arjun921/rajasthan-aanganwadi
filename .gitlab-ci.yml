test_server_api:
    image: "python:3.5"
    before_script:
        - cd server
        - pip install virtualenv
        - virtualenv venv
        - venv/bin/pip install -r requirements.txt
        - venv/bin/python --version
    script:
        - "venv/bin/coverage run -p server.py &"
        - "venv/bin/pytest tests"
        - "jobs -p|xargs kill -s 2"
        - "jobs -p|xargs kill -s 2"
        - "jobs -p|xargs kill -s 2"
        - jobs
        - "jobs -p|xargs kill"
        - "jobs -p|xargs kill -s 9"
        - coverage commbine
        - coverage report  --include="./*"
    stage: test
    coverage: '/TOTAL\s*\d+\s*\d+\s*(\d+)\%$/'
    after_script:
        - kill %-
